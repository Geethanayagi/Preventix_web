<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Risk Prediction & Care Plan</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      padding: 20px;
    }
    .container {
      max-width: 700px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
      color: #333;
    }
    .input-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: bold;
    }
    input[type="number"], input[type="text"] {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    .switch {
      display: flex;
      align-items: center;
      margin-top: 8px;
    }
    .switch label {
      flex: 1;
    }
    .switch input {
      width: 20px;
      height: 20px;
    }
    button {
      width: 100%;
      padding: 12px;
      margin-top: 12px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
    }
    #predictBtn { background: #007bff; color: white; }
    #downloadBtn { background: #28a745; color: white; display: none; }
    #result {
      margin-top: 20px;
      padding: 15px;
      background: #eef;
      border-radius: 8px;
    }
    .risk-card {
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 10px;
      background: #fff;
      box-shadow: 0px 4px 10px rgba(0,0,0,0.1);
    }
    .risk-high { border-left: 6px solid red; }
    .risk-medium { border-left: 6px solid orange; }
    .risk-low { border-left: 6px solid green; }
    .risk-title { font-weight: bold; }
    .probability { font-size: 14px; color: #555; }
    .cp-title { font-weight: bold; margin-top: 10px; }
    .cp-list { margin-left: 20px; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Risk Prediction & Care Plan</h2>

    <!-- Basic Info -->
    <div class="input-group"><label>Patient ID</label><input type="text" id="patient_id"></div>
    <div class="input-group"><label>Name</label><input type="text" id="name"></div>
    <div class="input-group"><label>Age</label><input type="number" id="age"></div>
    <div class="input-group"><label>Gender (0=Female,1=Male)</label><input type="number" id="gender"></div>

    <!-- Numeric Inputs -->
    <div class="input-group"><label>Systolic BP</label><input type="number" id="systolic"></div>
    <div class="input-group"><label>Diastolic BP</label><input type="number" id="diastolic"></div>
    <div class="input-group"><label>BMI</label><input type="number" id="bmi"></div>
    <div class="input-group"><label>Cholesterol</label><input type="number" id="cholesterol"></div>
    <div class="input-group"><label>Glucose</label><input type="number" id="glucose"></div>
    <div class="input-group"><label>HbA1c</label><input type="number" id="HbA1c"></div>
    <div class="input-group"><label>Insulin</label><input type="number" id="insulin"></div>
    <div class="input-group"><label>Heart Rate</label><input type="number" id="heart_rate"></div>
    <div class="input-group"><label>Diabetes Pedigree</label><input type="number" id="diabetes_pedigree"></div>
    <div class="input-group"><label>Poor Health Days</label><input type="number" id="poor_health_days"></div>
    <div class="input-group"><label>Max Heart Rate</label><input type="number" id="max_heart_rate"></div>

    <!-- Yes/No Switches -->
    <div class="switch"><label>Smoking:</label><input type="checkbox" id="smoking"></div>
    <div class="switch"><label>Alcohol:</label><input type="checkbox" id="alcohol"></div>
    <div class="switch"><label>Family History:</label><input type="checkbox" id="family_history"></div>
    <div class="switch"><label>Physical Activity:</label><input type="checkbox" id="physical_activity"></div>
    <div class="switch"><label>High Sodium Intake:</label><input type="checkbox" id="sodium_intake"></div>
    <div class="switch"><label>Fruit Consumption:</label><input type="checkbox" id="fruit"></div>
    <div class="switch"><label>Veggie Consumption:</label><input type="checkbox" id="veggies"></div>
    <div class="switch"><label>Stroke History:</label><input type="checkbox" id="stroke"></div>
    <div class="switch"><label>Fasting Blood Sugar:</label><input type="checkbox" id="fasting_blood_sugar"></div>

    <button id="predictBtn">Predict Risk</button>
    <button id="downloadBtn">Download Care Plan PDF</button>

    <div id="result"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const API_URL = "";

    // --- Utilities ---
    function escapeHTML(str) {
      return String(str).replace(/[&<>"']/g, (c) => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
      }[c]));
    }
    function prettyTitle(s) {
      return s.replace(/[_-]+/g, " ").replace(/\b\w/g, (c) => c.toUpperCase());
    }

    // Parse Care Plan
    function parseCarePlan(plan) {
    if (!plan) return [{ title: "Care Plan", items: ["No detailed plan provided."] }];

    // If already JSON, handle as before
    try {
      const obj = JSON.parse(plan);
      if (Array.isArray(obj)) {
        return obj.map(sec => ({ title: prettyTitle(sec.title), items: sec.items || [] }));
      }
    } catch {
      // continue to text-based parsing
    }

    // --- Text based parsing ---
    const sections = [];
    const lines = plan.split(/\*\*/).map(l => l.trim()).filter(Boolean);

    let currentSection = null;
    lines.forEach(line => {
      if (/^(Diabetes|Heart Disease|Hypertension|Diet Recommendations|Exercise Suggestions|Monitoring & Tests)/i.test(line)) {
        // New section
        if (currentSection) sections.push(currentSection);
        currentSection = { title: line.replace(/\*/g, "").trim(), items: [] };
      } else {
        if (currentSection) {
          // Clean and push as sub-item
          currentSection.items.push(line.replace(/^[-â€¢]\s*/, "").trim());
        }
      }
    });

    if (currentSection) sections.push(currentSection);
    return sections.length ? sections : [{ title: "Care Plan", items: [plan] }];
  }

  // --- Render with proper nesting ---
  function renderCarePlanHTML(sections) {
    return `
      <div class="care-plan">
        ${sections.map(sec => `
          <div class="cp-section">
            <h4 class="cp-title">${escapeHTML(sec.title)}</h4>
            <ul class="cp-list">
              ${(sec.items || []).map(it => `<li>${escapeHTML(it)}</li>`).join("")}
            </ul>
          </div>
        `).join("")}
      </div>
    `;
  }

    document.getElementById("predictBtn").addEventListener("click", async (e) => {
      e.preventDefault();
      const data = {
        patient_id: document.getElementById("patient_id").value,
        name: document.getElementById("name").value,
        age: +document.getElementById("age").value,
        gender: +document.getElementById("gender").value,
        systolic: +document.getElementById("systolic").value,
        diastolic: +document.getElementById("diastolic").value,
        blood_pressure: (
          (+document.getElementById("systolic").value + 2 * +document.getElementById("diastolic").value) / 3
        ).toFixed(2),
        cholesterol: +document.getElementById("cholesterol").value,
        bmi: +document.getElementById("bmi").value,
        glucose: +document.getElementById("glucose").value,
        HbA1c: +document.getElementById("HbA1c").value,
        insulin: +document.getElementById("insulin").value,
        heart_rate: +document.getElementById("heart_rate").value,
        smoking: document.getElementById("smoking").checked ? 1 : 0,
        alcohol: document.getElementById("alcohol").checked ? 1 : 0,
        family_history: document.getElementById("family_history").checked ? 1 : 0,
        physical_activity: document.getElementById("physical_activity").checked ? 1 : 0,
        sodium_intake: document.getElementById("sodium_intake").checked ? 1 : 0,
        fruit: document.getElementById("fruit").checked ? 1 : 0,
        veggies: document.getElementById("veggies").checked ? 1 : 0,
        stroke: document.getElementById("stroke").checked ? 1 : 0,
        fasting_blood_sugar: document.getElementById("fasting_blood_sugar").checked ? 1 : 0,
        diabetes_pedigree: +document.getElementById("diabetes_pedigree").value,
        poor_health_days: +document.getElementById("poor_health_days").value,
        max_heart_rate: +document.getElementById("max_heart_rate").value,
      };

      try {
        const response = await fetch(`${API_URL}/predict`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });
        if (!response.ok) throw new Error("API Error");
        const result = await response.json();

        // Risk cards
        let riskHTML = "";
        for (const [condition, details] of Object.entries(result.predictions || {})) {
          let riskClass = "risk-low";
          if (details.risk_label.toUpperCase().includes("HIGH")) riskClass = "risk-high";
          else if (details.risk_label.toUpperCase().includes("MEDIUM")) riskClass = "risk-medium";
          riskHTML += `
            <div class="risk-card ${riskClass}">
              <div class="risk-title">${condition.replace(/_/g, " ").toUpperCase()}</div>
              <div class="probability">Probability: ${(details.probability * 100).toFixed(1)}%</div>
              <div class="risk-label">Risk Level: <b>${details.risk_label}</b></div>
              <div class="risk-desc">Range: ${details.risk_description}</div>
            </div>
          `;
        }

        // Care Plan
        const sections = parseCarePlan(result.care_plan);
        const carePlanHTML = renderCarePlanHTML(sections);

        document.getElementById("result").innerHTML = `
          <h3>Prediction Result</h3>
          ${riskHTML}
          <h4>Care Plan</h4>
          ${carePlanHTML}
          ${result.pdf_url ? `<a class="download-link" href="${result.pdf_url}" target="_blank">ðŸ“„ Download Full Report (Server PDF)</a>` : ""}
        `;

        document.getElementById("downloadBtn").style.display = "block";
        document.getElementById("downloadBtn").onclick = () => {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();
          const left = 20;
          let y = 20;

          doc.setFontSize(16);
          doc.text("Care Plan Report", left, y);
          y += 10;

          doc.setFontSize(11);
          doc.text(`Patient: ${data.name || "-"} (ID: ${data.patient_id || "-"})`, left, y);
          y += 12;

          doc.setFont(undefined, "bold");
          doc.text("Risk Summary", left, y);
          doc.setFont(undefined, "normal");
          y += 8;

          for (const [condition, details] of Object.entries(result.predictions || {})) {
            const line = `${condition.replace(/_/g, " ").toUpperCase()}: ${(details.probability * 100).toFixed(1)}% - ${details.risk_label}`;
            const wrapped = doc.splitTextToSize(line, 170);
            wrapped.forEach((ln) => {
              if (y > 280) { doc.addPage(); y = 20; }
              doc.text(ln, left, y);
              y += 7;
            });
            y += 3;
          }

          if (y > 260) { doc.addPage(); y = 20; }
          doc.setFont(undefined, "bold");
          doc.text("Care Plan", left, y);
          doc.setFont(undefined, "normal");
          y += 8;

          sections.forEach(sec => {
            if (y > 275) { doc.addPage(); y = 20; }
            doc.setFont(undefined, "bold");
            doc.text(sec.title, left, y);
            doc.setFont(undefined, "normal");
            y += 7;
            (sec.items || []).forEach(item => {
              const bullet = "â€¢ " + item;
              const wrapped = doc.splitTextToSize(bullet, 170);
              wrapped.forEach((ln) => {
                if (y > 280) { doc.addPage(); y = 20; }
                doc.text(ln, left, y);
                y += 6;
              });
              y += 2;
            });
            y += 4;
          });

          doc.save("CarePlan.pdf");
        };

      } catch (err) {
        alert("Error: " + err.message);
      }
    });
  </script>
</body>
</html>

